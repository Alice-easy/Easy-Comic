# Phase 4 CI/CD æµæ°´çº¿é…ç½®
name: Easy Comic Phase 4 CI/CD

on:
  push:
    branches: [ main, develop, phase-4 ]
  pull_request:
    branches: [ main ]

jobs:
  test-and-quality:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Cache Gradle packages
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
          
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
      
    # Phase 4 ä»»åŠ¡ 1: å•å…ƒæµ‹è¯•è¦†ç›–
    - name: Run Unit Tests
      run: ./gradlew test --continue
      
    - name: Generate Test Coverage Report
      run: ./gradlew jacocoTestReport
      
    # Phase 4 ä»»åŠ¡ 2: æ€§èƒ½åŸºå‡†æµ‹è¯•
    - name: Run Performance Benchmark Tests
      run: ./gradlew :app:testDebugUnitTest --tests "*PerformanceBenchmarkTest"
      
    # Phase 4 ä»»åŠ¡ 3: ä»£ç è´¨é‡æ£€æŸ¥
    - name: Run Lint
      run: ./gradlew lint
      
    - name: Run Detekt (Static Analysis)
      run: ./gradlew detekt
      continue-on-error: true
      
    # Phase 4 ä»»åŠ¡ 4: æ„å»ºæ£€æŸ¥
    - name: Build Debug APK
      run: ./gradlew assembleDebug
      
    - name: Build Release APK
      run: ./gradlew assembleRelease
      
    # æµ‹è¯•æŠ¥å‘Šä¸Šä¼ 
    - name: Upload Test Results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: test-results
        path: |
          **/build/reports/tests/
          **/build/reports/jacoco/
          **/build/reports/lint-results*.html
          
    # æ€§èƒ½æŠ¥å‘Š
    - name: Upload Performance Reports
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: performance-reports
        path: |
          **/build/reports/tests/**/PerformanceBenchmarkTest.html
          
  # Android UI æµ‹è¯• (Phase 4 æ‰©å±•)
  android-test:
    runs-on: macos-latest
    needs: test-and-quality
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Cache Gradle packages
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
      
    - name: Run Android UI Tests
      uses: reactivecircus/android-emulator-runner@v2
      with:
        api-level: 30
        target: google_apis
        arch: x86_64
        script: ./gradlew connectedAndroidTest
        
  # å‘å¸ƒå‡†å¤‡æ£€æŸ¥ (Phase 4)
  release-readiness:
    runs-on: ubuntu-latest
    needs: [test-and-quality, android-test]
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
      
    # Phase 4 å‘å¸ƒæ£€æŸ¥æ¸…å•
    - name: Check Release Readiness
      run: |
        echo "ğŸš€ Phase 4 Release Readiness Check"
        echo "================================="
        
        # æ£€æŸ¥ç‰ˆæœ¬å·
        echo "ğŸ“‹ Checking version information..."
        ./gradlew -q printVersion
        
        # æ£€æŸ¥æ‰€æœ‰æµ‹è¯•é€šè¿‡
        echo "ğŸ§ª Running final test suite..."
        ./gradlew test
        
        # æ£€æŸ¥ä»£ç è´¨é‡
        echo "ğŸ” Running quality checks..."
        ./gradlew lint detekt
        
        # æ„å»ºå‘å¸ƒç‰ˆæœ¬
        echo "ğŸ“¦ Building release APK..."
        ./gradlew assembleRelease
        
        # æ£€æŸ¥APKå¤§å°
        echo "ğŸ“Š Checking APK size..."
        ls -lh app/build/outputs/apk/release/*.apk
        
        echo "âœ… Release readiness check completed"
        
    - name: Upload Release APK
      uses: actions/upload-artifact@v3
      with:
        name: release-apk
        path: app/build/outputs/apk/release/*.apk
        
  # æ€§èƒ½å›å½’æ£€æµ‹
  performance-regression:
    runs-on: ubuntu-latest
    needs: test-and-quality
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Run Performance Regression Tests
      run: |
        echo "ğŸ“Š Performance Regression Check"
        echo "==============================="
        
        ./gradlew :app:testDebugUnitTest --tests "*PerformanceBenchmarkTest" --info
        
        # æ£€æŸ¥æ€§èƒ½æŒ‡æ ‡æ˜¯å¦åœ¨ç›®æ ‡èŒƒå›´å†…
        echo "Performance targets:"
        echo "- Startup time: < 1500ms"
        echo "- Page turn: < 80ms"  
        echo "- Search: < 300ms"
        echo "- Memory: < 120MB"
        
    - name: Performance Alert
      if: failure()
      run: |
        echo "âŒ Performance regression detected!"
        echo "Please review performance metrics and optimize before merging."
        exit 1
